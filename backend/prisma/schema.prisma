// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  STUDENT
  ADMIN
}

enum ClassLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  PROFESSIONAL
}

enum RegistrationStatus {
  ACTIVE
  INACTIVE
  CANCELLED
}

enum TicketStatus {
  PENDING
  CONFIRMED
  CANCELLED
  USED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

enum NotificationType {
  CLASS_REMINDER
  TICKET_CONFIRMATION
  PAYMENT_SUCCESS
  GENERAL
  ADMIN_BROADCAST
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String
  role          UserRole  @default(STUDENT)
  name          String
  phone         String?
  verified      Boolean   @default(false)
  verificationToken String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  studentProfile    StudentProfile?
  classRegistrations ClassRegistration[]
  tickets           Ticket[]
  notifications     Notification[]

  @@index([email])
  @@map("users")
}

model StudentProfile {
  id               String      @id @default(uuid())
  userId           String      @unique
  level            ClassLevel  @default(BEGINNER)
  guardianName     String?
  dateOfBirth      DateTime?
  address          String?
  emergencyContact String?
  medicalInfo      String?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("student_profiles")
}

model Class {
  id          String     @id @default(uuid())
  name        String
  style       String     // e.g., "Hip Hop", "Ballet", "Contemporary"
  level       ClassLevel
  instructor  String
  description String?

  // Schedule (recurring weekly)
  dayOfWeek   Int        // 0 = Sunday, 1 = Monday, etc.
  startTime   String     // e.g., "14:00"
  endTime     String     // e.g., "16:00"
  duration    Int        // minutes

  capacity    Int        @default(20)
  price       Float?     // optional class fee
  isActive    Boolean    @default(true)

  startDate   DateTime   // when class series starts
  endDate     DateTime?  // optional end date for class series

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations
  registrations ClassRegistration[]
  attendances   Attendance[]

  @@index([isActive, level])
  @@map("classes")
}

model ClassRegistration {
  id        String             @id @default(uuid())
  classId   String
  studentId String
  status    RegistrationStatus @default(ACTIVE)

  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  // Relations
  class   Class @relation(fields: [classId], references: [id], onDelete: Cascade)
  student User  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([classId, studentId])
  @@index([studentId])
  @@map("class_registrations")
}

model Attendance {
  id        String   @id @default(uuid())
  classId   String
  studentId String
  date      DateTime
  present   Boolean  @default(false)
  notes     String?

  createdAt DateTime @default(now())

  // Relations
  class Class @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([classId, studentId, date])
  @@index([classId, date])
  @@map("attendance")
}

model Event {
  id          String    @id @default(uuid())
  title       String
  description String?
  date        DateTime
  time        String
  venue       String
  capacity    Int
  price       Float
  imageUrl    String?
  isActive    Boolean   @default(true)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  tickets Ticket[]

  @@index([isActive, date])
  @@map("events")
}

model Ticket {
  id          String       @id @default(uuid())
  eventId     String

  // Buyer information (can be guest or registered user)
  buyerName   String
  buyerEmail  String
  buyerPhone  String
  userId      String?      // nullable for guest purchases

  // Ticket details
  ticketCode  String       @unique // human-readable code
  qrPayload   String       @unique // QR code data
  qrImageUrl  String?      // stored QR image URL
  status      TicketStatus @default(PENDING)

  issuedAt    DateTime?
  usedAt      DateTime?

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relations
  event       Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user        User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  paymentLog  PaymentLog?

  @@index([ticketCode])
  @@index([qrPayload])
  @@index([buyerEmail])
  @@index([eventId])
  @@map("tickets")
}

model PaymentLog {
  id         String        @id @default(uuid())
  ticketId   String?       @unique
  amount     Float
  currency   String        @default("NGN")
  reference  String        @unique // Paystack reference
  provider   String        @default("paystack")
  status     PaymentStatus @default(PENDING)

  // Store raw webhook payload for debugging
  rawPayload Json?

  // Additional metadata
  channel    String?       // payment channel used
  paidAt     DateTime?

  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  // Relations
  ticket Ticket? @relation(fields: [ticketId], references: [id], onDelete: SetNull)

  @@index([reference])
  @@index([status])
  @@map("payment_logs")
}

model Notification {
  id        String           @id @default(uuid())
  userId    String?          // nullable for system-wide notifications
  type      NotificationType
  title     String
  body      String
  read      Boolean          @default(false)

  // Optional metadata as JSON
  meta      Json?

  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([createdAt])
  @@map("notifications")
}

model SystemConfig {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("system_config")
}
