<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>My Tickets - Dance Class</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="" name="keywords">
    <meta content="" name="description">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Yantramanav:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Icon Font Stylesheet -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Libraries Stylesheet -->
    <link href="lib/animate/animate.min.css" rel="stylesheet">

    <!-- Customized Bootstrap Stylesheet -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Template Stylesheet -->
    <link href="css/style.css" rel="stylesheet">

    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

    <style>
        .page-header {
            background: linear-gradient(135deg, var(--bs-primary) 0%, var(--bs-secondary) 100%);
            padding: 60px 0;
            color: white;
            text-align: center;
        }

        .page-header h1 {
            font-size: 42px;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .page-header p {
            font-size: 18px;
            opacity: 0.95;
        }

        .page-container {
            padding: 60px 0;
            background: #f8f9fa;
        }

        .filter-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }

        .filter-card h5 {
            font-size: 18px;
            font-weight: 700;
            color: var(--bs-primary);
            margin-bottom: 20px;
        }

        .filter-btn {
            width: 100%;
            text-align: left;
            margin-bottom: 10px;
            border-radius: 8px;
        }

        .filter-btn.active {
            background: var(--bs-primary);
            color: white;
            border-color: var(--bs-primary);
        }

        .ticket-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .ticket-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: var(--bs-primary);
        }

        .ticket-card.status-confirmed::before {
            background: #198754;
        }

        .ticket-card.status-used::before {
            background: #6c757d;
        }

        .ticket-card.status-cancelled::before {
            background: #dc3545;
        }

        .ticket-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
        }

        .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px dashed #e0e0e0;
        }

        .ticket-title {
            font-size: 24px;
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
        }

        .ticket-subtitle {
            color: #666;
            font-size: 14px;
        }

        .ticket-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-item {
            display: flex;
            align-items: center;
            color: #666;
            font-size: 15px;
        }

        .info-item i {
            color: var(--bs-primary);
            margin-right: 10px;
            width: 20px;
        }

        .ticket-code-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .ticket-code {
            font-size: 24px;
            font-weight: 700;
            color: var(--bs-primary);
            font-family: 'Courier New', monospace;
            letter-spacing: 3px;
            margin: 10px 0;
        }

        .qr-code-container {
            margin: 20px 0;
            text-align: center;
        }

        .qr-code-container canvas {
            border: 5px solid white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .badge {
            font-size: 13px;
            padding: 8px 15px;
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state i {
            font-size: 80px;
            margin-bottom: 25px;
            opacity: 0.3;
        }

        .empty-state h4 {
            font-size: 24px;
            margin-bottom: 15px;
        }

        .empty-state p {
            font-size: 16px;
            margin-bottom: 25px;
        }

        .loading-spinner {
            text-align: center;
            padding: 60px;
        }

        @media (max-width: 768px) {
            .page-header h1 {
                font-size: 32px;
            }

            .ticket-card {
                padding: 20px;
            }

            .ticket-info {
                grid-template-columns: 1fr;
            }
        }

        @media print {
            .navbar, .footer, .copyright, .back-to-top, .no-print {
                display: none !important;
            }

            .ticket-card {
                page-break-inside: avoid;
                box-shadow: none;
                border: 2px solid #333;
            }
        }
    </style>
</head>

<body>

    <!-- Spinner Start -->
    <div id="spinner" class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>
    <!-- Spinner End -->

    <!-- Topbar Start -->
    <div class="container-fluid bg-secondary px-5 d-none d-lg-block">
        <div class="row gx-0 align-items-center" style="height: 45px;">
            <div class="col-lg-8 text-center text-lg-start mb-lg-0">
                <div class="d-flex flex-wrap">
                    <a href="#" class="text-light me-4"><i class="fas fa-map-marker-alt text-primary me-2"></i>Find A Location</a>
                    <a href="#" class="text-light me-4"><i class="fas fa-phone-alt text-primary me-2"></i>+01234567890</a>
                    <a href="#" class="text-light me-0"><i class="fas fa-envelope text-primary me-2"></i>Example@gmail.com</a>
                </div>
            </div>
            <div class="col-lg-4 text-center text-lg-end">
                <div class="d-flex justify-content-end">
                    <div class="border-end border-start py-1">
                        <a href="#" class="btn text-primary"><i class="fab fa-facebook-f"></i></a>
                    </div>
                    <div class="border-end py-1">
                        <a href="#" class="btn text-primary"><i class="fab fa-twitter"></i></a>
                    </div>
                    <div class="border-end py-1">
                        <a href="#" class="btn text-primary"><i class="fab fa-instagram"></i></a>
                    </div>
                    <div class="border-end py-1">
                        <a href="#" class="btn text-primary"><i class="fab fa-tiktok"></i></a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Topbar End -->

    <!-- Navbar Start -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white px-4 px-lg-5 py-3 py-lg-0 sticky-top">
        <a href="index.html" class="navbar-brand p-0">
            <h1 class="text-primary m-0"><i class="fas fa-biohazard me-3"></i>SOP</h1>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse">
            <span class="fa fa-bars"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarCollapse">
            <div class="navbar-nav ms-auto py-0">
                <a href="index.html" class="nav-item nav-link">Home</a>
                <a href="student-dashboard.html" class="nav-item nav-link">Dashboard</a>
                <a href="my-classes.html" class="nav-item nav-link">My Classes</a>
                <a href="my-tickets.html" class="nav-item nav-link active">My Tickets</a>
                <a href="classes.html" class="nav-item nav-link">Browse Classes</a>
                <a href="event.html" class="nav-item nav-link">Events</a>
            </div>
            <button class="btn btn-primary rounded-pill py-2 px-4 ms-lg-4 logout-btn">
                <i class="fas fa-sign-out-alt me-2"></i>Logout
            </button>
        </div>
    </nav>
    <!-- Navbar End -->

    <!-- Page Header Start -->
    <div class="page-header">
        <div class="container">
            <h1>My Event Tickets</h1>
            <p>View and manage your purchased event tickets</p>
        </div>
    </div>
    <!-- Page Header End -->

    <!-- Page Content Start -->
    <div class="container-fluid page-container">
        <div class="container">
            <div class="row">
                <!-- Sidebar Filters -->
                <div class="col-lg-3">
                    <div class="filter-card">
                        <h5><i class="fas fa-filter me-2"></i>Filter by Status</h5>
                        <button class="btn filter-btn btn-outline-primary active" onclick="filterTickets('ALL')">
                            <i class="fas fa-list me-2"></i>All Tickets
                        </button>
                        <button class="btn filter-btn btn-outline-success" onclick="filterTickets('CONFIRMED')">
                            <i class="fas fa-check-circle me-2"></i>Confirmed
                        </button>
                        <button class="btn filter-btn btn-outline-secondary" onclick="filterTickets('USED')">
                            <i class="fas fa-ticket-alt me-2"></i>Used
                        </button>
                        <button class="btn filter-btn btn-outline-danger" onclick="filterTickets('CANCELLED')">
                            <i class="fas fa-times-circle me-2"></i>Cancelled
                        </button>
                    </div>

                    <div class="filter-card">
                        <h5><i class="fas fa-info-circle me-2"></i>Quick Stats</h5>
                        <div class="mb-3">
                            <strong>Total Tickets:</strong>
                            <div class="h4 text-primary mb-0" id="totalTicketsCount">0</div>
                        </div>
                        <div class="mb-3">
                            <strong>Confirmed:</strong>
                            <div class="h4 text-success mb-0" id="confirmedCount">0</div>
                        </div>
                        <div>
                            <strong>Used:</strong>
                            <div class="h4 text-secondary mb-0" id="usedCount">0</div>
                        </div>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="col-lg-9">
                    <div id="ticketsList">
                        <div class="loading-spinner">
                            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-3">Loading your tickets...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Page Content End -->

    <!-- Footer Start -->
    <div class="container-fluid footer py-5 wow fadeIn" data-wow-delay="0.2s">
        <div class="container py-5">
            <div class="row g-5">
                <div class="col-md-6 col-lg-6 col-xl-3">
                    <div class="footer-item d-flex flex-column">
                        <h4 class="text-white mb-4"><i class="fas fa-biohazard me-3"></i>SOP Dance</h4>
                        <p>Join our vibrant dance community and discover your passion for movement.</p>
                        <div class="d-flex align-items-center">
                            <a class="btn-square btn btn-primary text-white rounded-circle me-2" href="#"><i class="fab fa-facebook-f"></i></a>
                            <a class="btn-square btn btn-primary text-white rounded-circle me-2" href="#"><i class="fab fa-twitter"></i></a>
                            <a class="btn-square btn btn-primary text-white rounded-circle me-2" href="#"><i class="fab fa-instagram"></i></a>
                            <a class="btn-square btn btn-primary text-white rounded-circle me-0" href="#"><i class="fab fa-tiktok"></i></a>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-6 col-xl-3">
                    <div class="footer-item d-flex flex-column">
                        <h4 class="mb-4 text-white">Quick Links</h4>
                        <a href="about.html"><i class="fas fa-angle-right me-2"></i> About</a>
                        <a href="classes.html"><i class="fas fa-angle-right me-2"></i> Classes</a>
                        <a href="event.html"><i class="fas fa-angle-right me-2"></i> Events</a>
                        <a href="contact.html"><i class="fas fa-angle-right me-2"></i> Contact</a>
                    </div>
                </div>
                <div class="col-md-6 col-lg-6 col-xl-3">
                    <div class="footer-item d-flex flex-column">
                        <h4 class="mb-4 text-white">Contact Info</h4>
                        <a href="#"><i class="fa fa-map-marker-alt me-2"></i> 123 Street, New York, USA</a>
                        <a href="#"><i class="fas fa-envelope me-2"></i> info@example.com</a>
                        <a href="#"><i class="fas fa-phone me-2"></i> +012 345 67890</a>
                    </div>
                </div>
                <div class="col-md-6 col-lg-6 col-xl-3">
                    <div class="footer-item d-flex flex-column">
                        <h4 class="mb-4 text-white">Opening Hours</h4>
                        <div class="mb-3">
                            <h6 class="text-muted mb-0">Mon - Friday:</h6>
                            <p class="text-white mb-0">09.00 am to 07.00 pm</p>
                        </div>
                        <div class="mb-3">
                            <h6 class="text-muted mb-0">Saturday:</h6>
                            <p class="text-white mb-0">10.00 am to 05.00 pm</p>
                        </div>
                        <div class="mb-3">
                            <h6 class="text-muted mb-0">Vacation:</h6>
                            <p class="text-white mb-0">All Sunday is our vacation</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Footer End -->

    <!-- Copyright Start -->
    <div class="container-fluid copyright py-4">
        <div class="container">
            <div class="row g-4 align-items-center">
                <div class="col-md-6 text-center text-md-start mb-md-0">
                    <span class="text-white"><a href="#"><i class="fas fa-copyright text-light me-2"></i>SOP Dance</a>, All right reserved.</span>
                </div>
                <div class="col-md-6 text-center text-md-end text-white">
                    Designed by <a class="border-bottom" href="https://htmlcodex.com">HTML Codex</a>
                </div>
            </div>
        </div>
    </div>
    <!-- Copyright End -->

    <!-- Back to Top -->
    <a href="#" class="btn btn-primary btn-lg-square back-to-top"><i class="fa fa-arrow-up"></i></a>

    <!-- JavaScript Libraries -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="lib/wow/wow.min.js"></script>
    <script src="lib/easing/easing.min.js"></script>
    <script src="lib/waypoints/waypoints.min.js"></script>
    <script src="lib/counterup/counterup.min.js"></script>

    <!-- Template Javascript -->
    <script src="js/main.js"></script>

    <!-- API & Auth Scripts -->
    <script src="js/api-config.js"></script>
    <script src="js/auth.js"></script>

    <!-- My Tickets Script -->
    <script>
        // Require student authentication
        requireStudent();

        let allTickets = [];
        let currentFilter = 'ALL';

        // Load tickets
        async function loadTickets() {
            try {
                const response = await apiGet(`${API_BASE_URL}/tickets/user/my-tickets`);
                allTickets = response.data || response || [];

                // Update counts
                updateCounts();

                // Display tickets
                displayTickets();

            } catch (error) {
                console.error('Error loading tickets:', error);
                document.getElementById('ticketsList').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <h4>Error Loading Tickets</h4>
                        <p>Unable to load your tickets. Please try again later.</p>
                        <button class="btn btn-primary" onclick="loadTickets()">Retry</button>
                    </div>
                `;
            }
        }

        // Update ticket counts
        function updateCounts() {
            document.getElementById('totalTicketsCount').textContent = allTickets.length;

            const confirmed = allTickets.filter(t => t.status === 'CONFIRMED').length;
            const used = allTickets.filter(t => t.status === 'USED').length;

            document.getElementById('confirmedCount').textContent = confirmed;
            document.getElementById('usedCount').textContent = used;
        }

        // Filter tickets
        function filterTickets(status) {
            currentFilter = status;

            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.filter-btn').classList.add('active');

            // Display filtered tickets
            displayTickets();
        }

        // Display tickets
        function displayTickets() {
            const container = document.getElementById('ticketsList');

            // Filter tickets based on current filter
            let filteredTickets = currentFilter === 'ALL'
                ? allTickets
                : allTickets.filter(t => t.status === currentFilter);

            if (filteredTickets.length === 0) {
                const message = currentFilter === 'ALL'
                    ? "You haven't purchased any event tickets yet."
                    : `No ${currentFilter.toLowerCase()} tickets found.`;

                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-ticket-alt"></i>
                        <h4>No Tickets Found</h4>
                        <p>${message}</p>
                        ${currentFilter === 'ALL' ? '<a href="event.html" class="btn btn-primary btn-lg"><i class="fas fa-calendar-alt me-2"></i>Browse Events</a>' : ''}
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredTickets.map(ticket => {
                const statusClass = ticket.status === 'CONFIRMED' ? 'success' :
                                  ticket.status === 'USED' ? 'secondary' : 'danger';
                const statusLower = ticket.status.toLowerCase();

                return `
                    <div class="ticket-card status-${statusLower}">
                        <div class="ticket-header">
                            <div>
                                <div class="ticket-title">${ticket.event?.title || ticket.eventTitle || 'Event Ticket'}</div>
                                <div class="ticket-subtitle">Ticket ID: ${ticket.id || ticket._id}</div>
                            </div>
                            <span class="badge bg-${statusClass}">${ticket.status}</span>
                        </div>

                        <div class="ticket-info">
                            <div class="info-item">
                                <i class="fas fa-calendar"></i>
                                <span><strong>Date:</strong> ${formatDate(ticket.event?.date || ticket.eventDate)}</span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-clock"></i>
                                <span><strong>Time:</strong> ${ticket.event?.time || ticket.eventTime || 'TBA'}</span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-map-marker-alt"></i>
                                <span><strong>Venue:</strong> ${ticket.event?.venue || ticket.venue || 'TBA'}</span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-tag"></i>
                                <span><strong>Type:</strong> ${ticket.ticketType || 'General'}</span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-dollar-sign"></i>
                                <span><strong>Price:</strong> ${ticket.amount ? '$' + ticket.amount : 'N/A'}</span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-calendar-plus"></i>
                                <span><strong>Purchased:</strong> ${formatDate(ticket.createdAt)}</span>
                            </div>
                        </div>

                        <div class="ticket-code-section">
                            <small class="text-muted d-block mb-2">Ticket Code</small>
                            <div class="ticket-code">${ticket.ticketCode || ticket.code}</div>
                            <small class="text-muted">Show this code at the event entrance</small>
                        </div>

                        <div class="qr-code-container">
                            <canvas id="qr-${ticket.id || ticket._id}"></canvas>
                        </div>

                        <div class="d-flex gap-2 no-print">
                            <button class="btn btn-primary" onclick="printTicket('${ticket.id || ticket._id}')">
                                <i class="fas fa-print me-2"></i>Print Ticket
                            </button>
                            <button class="btn btn-outline-primary" onclick="downloadQR('qr-${ticket.id || ticket._id}', '${ticket.ticketCode || ticket.code}')">
                                <i class="fas fa-download me-2"></i>Download QR
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            // Generate QR codes
            filteredTickets.forEach(ticket => {
                const canvas = document.getElementById(`qr-${ticket.id || ticket._id}`);
                if (canvas) {
                    QRCode.toCanvas(canvas, ticket.ticketCode || ticket.code, {
                        width: 200,
                        margin: 2,
                        color: {
                            dark: '#000000',
                            light: '#ffffff'
                        }
                    });
                }
            });
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'TBA';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // Print ticket
        function printTicket(ticketId) {
            window.print();
        }

        // Download QR code
        function downloadQR(canvasId, ticketCode) {
            const canvas = document.getElementById(canvasId);
            if (canvas) {
                const url = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = `ticket-${ticketCode}.png`;
                link.href = url;
                link.click();
            }
        }

        // Load tickets on page load
        loadTickets();
    </script>
</body>

</html>
